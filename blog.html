<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blog - Malcolm Buluku</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <header class="bg-green-700 text-white p-4">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <a href="/" class="font-bold">‚Üê Back</a>
      <button id="theme-toggle" class="ml-4 px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">üåô</button>
    </div>
  </header>

  <main class="max-w-3xl mx-auto p-6 bg-white dark:bg-gray-800 rounded-xl shadow mt-8">
    <article id="post"></article>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || window.__SUPABASE_URL;
    const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY || window.__SUPABASE_ANON_KEY;
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function loadPost() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      const container = document.getElementById("post");
      if (!id) {
        container.innerHTML = "<p class='text-red-600'>No post id provided.</p>";
        return;
      }

      const { data: post, error } = await supabase.from("blog").select("*").eq("id", id).single();
      if (error || !post) {
        container.innerHTML = "<p class='text-red-600'>Post not found.</p>";
        return;
      }

      const rendered = marked.parse(post.content || "");
      container.innerHTML = `
        <h1 class="text-3xl font-bold mb-4">${post.title}</h1>
        <p class="text-gray-500 mb-6">${new Date(post.published_at).toLocaleDateString()}</p>
        ${post.image_url ? `<img src="${post.image_url}" alt="${post.title}" class="rounded-xl mb-6 w-full">` : ""}
        <div class="prose dark:prose-dark max-w-none">${rendered}</div>
      `;
    }

    loadPost();
  </script>

  <!-- theme toggle fallback -->
  <script>
    (function () {
      const toggleBtn = document.getElementById("theme-toggle");
      const root = document.documentElement;

      function applySavedTheme() {
        if (localStorage.theme === "dark" || (!("theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
          root.classList.add("dark");
          if (toggleBtn) toggleBtn.textContent = "‚òÄÔ∏è";
        } else {
          root.classList.remove("dark");
          if (toggleBtn) toggleBtn.textContent = "üåô";
        }
      }
      applySavedTheme();

      if (toggleBtn) {
        toggleBtn.addEventListener("click", () => {
          if (root.classList.contains("dark")) {
            root.classList.remove("dark");
            localStorage.theme = "light";
            toggleBtn.textContent = "üåô";
          } else {
            root.classList.add("dark");
            localStorage.theme = "dark";
            toggleBtn.textContent = "‚òÄÔ∏è";
          }
        });
      }
    })();
  </script>
</body>
</html>
